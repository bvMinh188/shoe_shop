<div id="order-message" class="alert d-none" role="alert"></div>

<div class="container">
    <div class="col-md-12">
        <h4>L·ªãch s·ª≠ mua h√†ng</h4>

        {{#if orders.length}}
            {{#each orders}}
                <div class="order-item border rounded p-3 mb-4">
                    <h5>üõí M√£ ƒë∆°n h√†ng: <strong>{{this._id}}</strong></h5>
                    <div><strong>Th·ªùi gian ƒë·∫∑t h√†ng:</strong> {{formatDate this.createdAt}}</div>
                    
                    {{#each products}}
                        <div class="d-flex border-bottom pb-3 pt-3">
                            <img src="{{this.image}}" alt="product" class="img-thumbnail" width="80">
                            <div class="ms-3">
                                <div><strong>{{this.name}}</strong></div>
                                <div>Size: {{this.size}}</div>
                                <div>x{{this.quantity}}</div>
                            </div>
                        </div>
                    {{/each}}

                    <div class="mt-3">
                        <strong>ƒê·ªãa ch·ªâ:</strong> {{this.address}}
                    </div>
                    <div>
                        <strong>Th√†nh ti·ªÅn:</strong> <span class="text-danger">{{formatPrince this.price}}</span>
                    </div>
                    <div>
                        <strong>Tr·∫°ng th√°i:</strong> <span class="{{this.status}}">{{this.status}}</span>
                    </div>

                    {{#if (eq this.status "ch·ªù x√°c nh·∫≠n")}}
                        <div class="mt-3">
                            <button class="btn btn-danger cancel-order" data-id="{{this._id}}">H·ªßy ƒë∆°n</button>
                        </div>
                    {{/if}}

                </div>
            {{/each}}
        {{else}}
            <div class="alert alert-warning">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</div>
        {{/if}}
    </div>
</div>

<!-- Modal H·ªßy ƒê∆°n -->
<div id="cancelOrderModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">X√°c nh·∫≠n h·ªßy ƒë∆°n</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng n√†y kh√¥ng?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
        <button id="confirmCancelOrder" type="button" class="btn btn-danger">X√°c nh·∫≠n h·ªßy</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let selectedOrderId = null;

    function showAlert(message, type = "success") {
        const orderMessage = document.getElementById("order-message");
        orderMessage.textContent = message;
        orderMessage.className = `alert alert-${type}`;
        orderMessage.classList.remove("d-none");

        setTimeout(() => {
            orderMessage.classList.add("d-none");
        }, 2000);
    }

    // Khi b·∫•m "H·ªßy ƒë∆°n", m·ªü modal
    document.querySelectorAll(".cancel-order").forEach(button => {
        button.addEventListener("click", function () {
            selectedOrderId = this.dataset.id;
            $("#cancelOrderModal").modal("show");
        });
    });

    // Khi b·∫•m "X√°c nh·∫≠n h·ªßy", g·ª≠i request DELETE
    document.getElementById("confirmCancelOrder").addEventListener("click", function () {
        if (selectedOrderId) {
            fetch(`/purchase/transaction/${selectedOrderId}`, { method: "DELETE" })
                .then(response => response.json())
                .then(data => {
                    if (data.success || data.message.includes("h·ªßy th√†nh c√¥ng")) {
                        showAlert("ƒê√£ h·ªßy ƒë∆°n h√†ng th√†nh c√¥ng!", "danger");
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showAlert("L·ªói: " + data.message, "danger");
                    }
                })
                .catch(error => {
                    console.error("L·ªói fetch API:", error);
                    showAlert("C√≥ l·ªói x·∫£y ra khi h·ªßy ƒë∆°n h√†ng.", "danger");
                });

            // ƒê√≥ng modal sau khi nh·∫•n "X√°c nh·∫≠n h·ªßy"
            $("#cancelOrderModal").modal("hide");
        }
    });

    // ƒê·∫£m b·∫£o modal ƒë√≥ng khi b·∫•m n√∫t "ƒê√≥ng" ho·∫∑c "Thu l·∫°i"
    document.querySelectorAll('[data-dismiss="modal"]').forEach(button => {
        button.addEventListener("click", function () {
            $("#cancelOrderModal").modal("hide");
        });
    });
});
</script>

